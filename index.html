<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜ŸåŸŸä¸»å®° | çš‡å®¶å¾¡ç”¨å­¸ç¿’ç³»çµ±</title>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Pro -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Noto+Serif+TC:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        fantasy: ['"Cinzel"', '"Noto Serif TC"', 'serif'],
                        body: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        gold: '#FFD700',
                        'gold-dim': '#C5A059',
                        accent: '#a855f7', 
                        glass: 'rgba(15, 15, 28, 0.95)',
                    },
                    animation: {
                        'spin-slow': 'spin 30s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-glow': 'pulse-glow 2s infinite',
                        'twinkle': 'twinkle 4s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-6px)' } },
                        'pulse-glow': { 
                            '0%, 100%': { boxShadow: '0 0 10px rgba(168, 85, 247, 0.3), inset 0 0 5px rgba(168, 85, 247, 0.1)' }, 
                            '50%': { boxShadow: '0 0 25px rgba(168, 85, 247, 0.6), inset 0 0 15px rgba(168, 85, 247, 0.3)' } 
                        },
                        twinkle: {
                            '0%, 100%': { opacity: 0.8, transform: 'scale(1)' },
                            '50%': { opacity: 0.4, transform: 'scale(0.8)' }
                        },
                        fadeIn: {
                            '0%': { opacity: 0, transform: 'translateY(10px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* === ğŸŒŒ æ˜Ÿé›²èƒŒæ™¯ === */
        body {
            margin: 0; padding: 0;
            background-color: #050510;
            font-family: 'Noto Sans TC', sans-serif;
            color: #E2E8F0;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.4), transparent 40%),
                radial-gradient(circle at 85% 30%, rgba(59, 130, 246, 0.25), transparent 40%),
                radial-gradient(circle at 50% 80%, rgba(217, 70, 239, 0.2), transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(15, 23, 42, 0.8), rgba(5, 5, 10, 1));
            background-attachment: fixed;
        }

        .stars {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
                              radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
                              radial-gradient(1px 1px at 90px 40px, #fff, rgba(0,0,0,0));
            background-size: 200px 200px;
            animation: twinkle 8s infinite;
            z-index: -1; opacity: 0.7;
        }

        /* === ğŸ”® é¢æ¿èˆ‡äº’å‹• === */
        .arcane-panel {
            background: rgba(20, 20, 35, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; z-index: 10;
        }
        
        .arcane-panel:hover {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.25);
            transform: translateY(-2px);
        }

        .text-gold-glow {
            font-family: 'Cinzel', serif;
            background: linear-gradient(180deg, #FFFFFF 20%, #FFD700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            font-weight: 700; letter-spacing: 1px;
        }

        .magic-input {
            background: rgba(0, 0, 0, 0.7) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: #FFF !important; transition: all 0.3s;
        }
        .magic-input:focus {
            border-color: #FFD700 !important;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            background: rgba(0, 0, 0, 0.9) !important; outline: none;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, #4C1D95, #7C3AED); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #8B5CF6; }

        .soul-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #FFD700, #B8860B, #000);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
            position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #FFD700;
        }
        .soul-avatar::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.8) 50%, transparent 60%);
            animation: shine 4s infinite;
        }
        @keyframes shine { 0% { transform: translateX(-150%) translateY(-150%); } 100% { transform: translateX(150%) translateY(150%); } }

        .btn-primary {
            background: linear-gradient(135deg, #4C1D95 0%, #6D28D9 100%);
            border: 1px solid #8B5CF6; color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: all 0.2s; cursor: pointer; position: relative; z-index: 50;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5B21B6 0%, #7C3AED 100%);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.5); transform: scale(1.02);
        }
        .btn-primary:active { transform: scale(0.98); }

        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 220px; background-color: rgba(0,0,0,0.95);
            color: #fff; text-align: left; border-radius: 6px; padding: 8px; border: 1px solid #FFD700;
            position: absolute; z-index: 100; bottom: 125%; left: 50%; margin-left: -110px;
            opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; pointer-events: none;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    </style>
</head>
<body>
    <div class="stars"></div>
    <div id="root" class="relative z-10 p-4 min-h-screen"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ğŸ”Š éŸ³æ•ˆå¼•æ“ ---
        class SoundEngine {
            constructor() { this.ctx = null; }
            init() {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            }
            playTone(freq, type, duration, vol=0.1) {
                if(!this.ctx) return;
                try {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + duration);
                } catch(e) {}
            }
            playFanfare() { 
                this.init();
                [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => setTimeout(() => this.playTone(f, 'triangle', 0.4, 0.2), i * 150));
            }
            playSFX(type) {
                this.init();
                switch(type) {
                    case 'hover': this.playTone(400, 'sine', 0.05, 0.02); break;
                    case 'click': this.playTone(800, 'triangle', 0.1, 0.05); break;
                    case 'error': this.playTone(150, 'sawtooth', 0.2, 0.1); break;
                    case 'money': this.playTone(1200, 'sine', 0.1, 0.05); setTimeout(() => this.playTone(1800, 'sine', 0.2, 0.05), 80); break;
                }
            }
        }
        const soundEngine = new SoundEngine();

        // --- ğŸŒŒ ç³»çµ±å¸¸æ•¸ ---
        const DEFAULT_TITLES = [
            { name: "ğŸ‘£ é€æ˜Ÿæ—…äºº", req: 0 }, { name: "âœ¨ æ˜Ÿè¼è¡Œè€…", req: 1000 },
            { name: "ğŸŒ™ éŠ€æœˆå…ˆé©…", req: 3000 }, { name: "â˜€ï¸ é‡‘é™½çœŸå›", req: 6000 },
            { name: "ğŸŒŒ éŠ€æ²³å…ˆçŸ¥", req: 10000 }, { name: "ğŸª æ˜ŸåŸŸçµ±å¾¡", req: 15000 },
            { name: "ğŸŒ€ å®‡å®™ä¸»å®°", req: 25000 }, { name: "â³ æ™‚ç©ºè–è³¢", req: 40000 },
            { name: "ğŸ’« æ°¸æ†ç¥ä¸»", req: 60000 }, { name: "ğŸŒŸ å‰µä¸–å¤©å°Š", req: 100000 }
        ];

        const CURRENCIES = {
            mithril: { name: "ç§˜éŠ€æ˜Ÿå±‘", icon: "fa-gem", color: "text-blue-300", desc: "å®Œæˆæ—¥å¸¸ä»»å‹™ç²å¾—ã€‚" },
            star:    { name: "æ˜Ÿè€€å°è¨˜", icon: "fa-star", color: "text-yellow-400", desc: "å–®æ¬¡å°ˆæ³¨æ™‚é–“é”æ¨™ç²å¾—ã€‚" },
            ripple:  { name: "ä¸æ¯æ¼£æ¼ª", icon: "fa-water", color: "text-cyan-400", desc: "æ¯æ—¥é€£çºŒæ‰“å¡ç²å¾—ã€‚" },
            seed:    { name: "å•Ÿè’™ä¹‹ç¨®", icon: "fa-seedling", color: "text-green-400", desc: "è§£é–æˆå°±æ™‚ç²å¾—ã€‚" },
            soul:    { name: "éˆé­‚åˆ»å°", icon: "fa-fire", color: "text-red-500", desc: "å®Œæˆé«˜é›£åº¦ä»»å‹™ç²å¾—ã€‚" }
        };

        const DEFAULT_RULES = {
            money_per_min: 10, 
            diff_easy: 1, diff_med: 1.5, diff_hard: 2, diff_ext: 3,
            hate_mult: 1.2, star_threshold: 60, checkin_reward: 1, achv_reward: 10,
            reset_hour: 4, // å‡Œæ™¨4é»é‡ç½®
            daily_target_def: 300,
            weekly_target_def: 2000,
            music_url: null, music_volume: 0.3
        };

        const INITIAL_DATA = {
            userName: "",
            setupComplete: false,
            titles: DEFAULT_TITLES,
            subjects: ["è‹±æ–‡", "ä¸­æ–‡", "æ•¸å­¸", "ç‰©ç†", "åŒ–å­¸", "ç”Ÿç‰©", "æ­·å²"],
            rules: DEFAULT_RULES,
            profile: {
                xp: 0, streak: 0, last_login: "", 
                coins_mithril: 0, coins_star: 0, coins_ripple: 0, coins_seed: 0, coins_soul: 0,
                today_coins: 0, weekly_coins: 0,
                day_type: "ğŸ« ä¸Šå­¸æ—¥", checked_in: false,
                check_in_history: [],
                custom_daily_target: null,
                custom_daily_note: "",
            },
            daily_records: {}, // YYYY-MM-DD: { note: "", achieved: 0, target: 0 }
            tasks: [],
            goals: [
                { id: 1, subject: "è‹±æ–‡", name: "èƒŒå–®å­—", priority: "High", status: "é€²è¡Œä¸­", deadline: new Date().toISOString().split('T')[0] }
            ],
            shop: [
                { id: 1, name: "30åˆ†é˜éŠæˆ²æ™‚é–“", cost: 10, currency: "mithril", desc: "ç¨ä½œä¼‘æ¯", type: "consumable" },
                { id: 2, name: "ä¸€æ—¥ä¼‘æ¯å·", cost: 300, currency: "mithril", desc: "ä»Šæ—¥ç›®æ¨™æ­¸é›¶", type: "functional", effect: "rest_day" }
            ],
            inventory: {}, 
            history: [], 
            adventure_log: [], 
            achievements: [
                { id: "c1", name: "åˆå…¥ä¸–ç•Œ", desc: "é¦–æ¬¡ä½¿ç”¨æœ¬ç³»çµ±", reward: 10, currency: "seed", completed: false }
            ]
        };

// --- ğŸ”® å¢ƒç•Œé è¦½ Modal (å·²ç§»å‡º App) ---
const RankModal = ({ onClose, data, setData, titleData }) => {
    const [editMode, setEditMode] = useState(false);
    const [tempTitles, setTempTitles] = useState(data.titles);

    return (
        <div className="fixed inset-0 bg-black/90 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-float" onClick={onClose}>
            <div className="arcane-panel max-w-2xl w-full p-8 relative border-gold/30" onClick={e => e.stopPropagation()}>
                <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white"><i className="fa-solid fa-times fa-xl"></i></button>
                <div className="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
                    <h2 className="text-3xl font-fantasy text-gold text-center">å¢ƒç•Œæ™‰å‡éšæ¢¯</h2>
                    <button onClick={() => { if(editMode) setData(p => ({...p, titles: tempTitles})); setEditMode(!editMode); }} className="text-sm bg-slate-700 px-3 py-1 rounded">{editMode?'ä¿å­˜':'ç·¨è¼¯è¦å‰‡'}</button>
                </div>
                <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                    {tempTitles.map((t, i) => (
                        <div key={i} className="p-4 rounded-xl border flex items-center gap-4 border-white/5 bg-black/30">
                            <div className="text-2xl w-12 text-center">{i < titleData.idx ? 'âœ…' : (i === titleData.idx ? 'ğŸ§™â€â™‚ï¸' : 'ğŸ”’')}</div>
                            <div className="flex-1">
                                <div className="font-bold text-lg font-fantasy text-gold">{t.name}</div>
                                <div className="text-xs opacity-60 font-mono">éœ€æ±‚ç§˜éŠ€: {editMode ? <input type="number" className="bg-black border p-1 w-24" value={t.req} onChange={e => { const n = [...tempTitles]; n[i].req = Number(e.target.value); setTempTitles(n); }} /> : t.req}</div>
                            </div>
                            {i === titleData.idx && <div className="text-xs text-gold font-bold px-2 py-1 bg-gold/10 rounded">ç•¶å‰å¢ƒç•Œ</div>}
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

// --- ä¾§è¾¹æ  (å·²ç§»å‡º App) ---
const Sidebar = ({ data, setData, titleData, showToast, setModal, audioRef, soundEngine }) => {
    const [showRanks, setShowRanks] = useState(false);
    const [showHelp, setShowHelp] = useState(false);
    const [editingDaily, setEditingDaily] = useState(false);
    const [editingCurrency, setEditingCurrency] = useState(false); // è¨˜å¾—è£œä¸Šé€™è¡Œï¼ŒåŸæœ¬å¯èƒ½éºæ¼

    // ç°¡å–®çš„é‚è¼¯æ—¥æœŸè¨ˆç®— (è¤‡è£½éä¾†ä»¥ç¨ç«‹é‹ä½œ)
    const getLogicalDate = () => {
        const now = new Date();
        const resetHour = data.rules.reset_hour || 0;
        if (now.getHours() < resetHour) now.setDate(now.getDate() - 1);
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    };

    const logicalDate = getLogicalDate();
    const target = data.profile.custom_daily_target || data.rules.daily_target_def || 300;
    const weekTarget = data.rules.weekly_target_def || 2000;
    
    const handleCheckIn = () => {
        if(data.profile.today_coins >= target) {
            const today = logicalDate;
            if(data.profile.check_in_history.includes(today)) { soundEngine.playSFX('error'); return showToast("å·²æ‰“å¡", "check"); }
            setData(p => ({
                ...p, profile: { ...p.profile, streak: p.profile.streak+1, checked_in: true, coins_ripple: p.profile.coins_ripple+data.rules.checkin_reward, check_in_history: [...p.profile.check_in_history, today] }
            }));
            soundEngine.playFanfare();
            showToast("æ‰“å¡æˆåŠŸï¼", "water");
        } else { soundEngine.playSFX('error'); showToast("é­”åŠ›æœªé”æ¨™", "ban"); }
    };

    const endDay = () => {
        const todayStr = logicalDate;
        const record = {
            note: data.profile.custom_daily_note || "",
            target: target,
            achieved: data.profile.today_coins
        };
        setData(prev => ({
            ...prev,
            daily_records: { ...prev.daily_records, [todayStr]: record }
        }));
        setModal({ type: 'end_day_summary' });
        soundEngine.playFanfare();
    };

    // RankModal éœ€è¦å¾é€™è£¡å‚³é props é€²å»ï¼Œæˆ–è€…ä½ ä¹ŸæŠŠ RankModal ç§»å‡ºä¾†
    // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡å‡è¨­ RankModal å·²ç¶“å®šç¾©åœ¨ Sidebar ä¸Šæ–¹æˆ–å…¨åŸŸ
    // å¦‚æœ RankModal é‚„åœ¨ App è£¡ï¼Œä½ ä¹Ÿéœ€è¦æŠŠå®ƒç§»å‡ºä¾†æ”¾åˆ°å…¨åŸŸ

    return (
        <div className="w-full lg:w-80 flex-shrink-0 space-y-6">
            {/* æ³¨æ„ï¼šRankModal ä¹Ÿéœ€è¦èƒ½æ¥æ”¶ props æˆ– setData */}
            {showRanks && <RankModal onClose={() => setShowRanks(false)} titleData={titleData} data={data} setData={setData} />}
            
            <div className="arcane-panel p-6 text-center pt-10 relative overflow-hidden border-t-2 border-t-gold/50 shadow-[0_0_30px_rgba(0,0,0,0.5)]">
                <div className="absolute top-2 right-2 text-xs text-gray-500 font-mono tracking-widest">{data.userName}</div>
                <div className="w-28 h-28 mx-auto mb-4 soul-avatar animate-pulse-glow"><i className="fa-solid fa-user-astronaut text-5xl text-gold drop-shadow-lg"></i></div>
                <h2 className="text-2xl font-fantasy text-gold-glow font-bold mb-1">{titleData.current}</h2>
                <p className="text-xs text-accent mb-4 tracking-widest font-bold">Level {titleData.level}</p>
                <div className="relative h-2 bg-black rounded-full overflow-hidden border border-white/10 mb-2 mx-2"><div className="absolute top-0 left-0 h-full bg-gradient-to-r from-gold to-orange-500 transition-all duration-1000 shadow-[0_0_10px_#FFD700]" style={{width: `${titleData.progress}%`}}></div></div>
                <div className="flex justify-between text-[10px] text-gray-400 px-2 mb-4"><span>{Math.floor(data.profile.coins_mithril%1000)} XP</span><span>Next: {titleData.nextReq}</span></div>
                <button onClick={() => setShowRanks(true)} className="w-full py-1.5 text-xs border border-white/10 bg-white/5 rounded hover:bg-white/10 text-gray-300 transition flex items-center justify-center gap-2 hover:border-gold/30 hover:text-gold"><i className="fa-solid fa-eye"></i> é è¦½èˆ‡ç·¨è¼¯å¢ƒç•Œ</button>
            </div>

            <div className="arcane-panel p-4 relative">
                <div className="flex justify-between items-center mb-3 border-b border-white/5 pb-2">
                    <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest">æ¬¡å…ƒè¡Œå›Š</h3>
                    <div className="flex gap-2">
                        <button onClick={() => setEditingCurrency(!editingCurrency)} className={`text-xs ${editingCurrency?'text-green-400':'text-gray-500 hover:text-white'}`}><i className="fa-solid fa-pen"></i></button>
                        <button onClick={() => setShowHelp(!showHelp)} className="text-xs text-gray-500 hover:text-white"><i className="fa-solid fa-circle-question"></i></button>
                    </div>
                </div>
                
                {showHelp && <div className="absolute inset-0 bg-black/95 z-20 p-4 text-xs text-gray-300 rounded-xl" onClick={() => setShowHelp(false)}>{Object.values(CURRENCIES).map(c => <div key={c.name} className="mb-2"><span className="text-gold">{c.icon}</span> <span className="font-bold">{c.name}</span><br/>{c.desc}</div>)}</div>}
                
                <div className="space-y-2">
                    {Object.entries(CURRENCIES).map(([k, v]) => (
                        <div key={k} className="flex justify-between items-center text-sm p-2 rounded hover:bg-white/5 transition">
                            <span className={`flex items-center gap-2 ${v.color} font-bold`}><i className={`fa-solid ${v.icon} w-5 text-center`}></i> {v.name}</span>
                            {editingCurrency ? (
                                <input type="number" className="bg-black border border-white/20 w-20 text-right rounded px-1 text-white" value={Math.floor(data.profile[`coins_${k}`])} onChange={(e) => setData(p => ({...p, profile: {...p.profile, [`coins_${k}`]: Number(e.target.value)}}))} />
                            ) : (
                                <span className="font-mono font-bold text-white text-shadow">{Math.floor(data.profile[`coins_${k}`])}</span>
                            )}
                        </div>
                    ))}
                </div>
            </div>

            <div className="arcane-panel p-4 animate-pulse-glow border border-accent/30">
                <div className="flex justify-between items-center mb-2">
                    <span className="font-bold text-white text-sm">æ¯æ—¥ç‹€æ…‹</span>
                    <div className="flex gap-2">
                        <button onClick={() => setEditingDaily(!editingDaily)} className="text-xs text-gray-400 hover:text-white"><i className="fa-solid fa-pen-to-square"></i></button>
                        <select className="bg-black border border-white/20 text-xs rounded px-1 text-gray-300 outline-none hover:border-accent transition" value={data.profile.day_type} onChange={e => setData(p => ({...p, profile: {...p.profile, day_type: e.target.value}}))}>{["ğŸ« ä¸Šå­¸æ—¥", "ğŸ“… é€±æœ«", "ğŸ–ï¸ å‡æœŸ", "ğŸ¤’ ç—…å‡"].map(o => <option key={o} value={o}>{o}</option>)}</select>
                    </div>
                </div>
                
                {/* Daily Progress */}
                <div className="mb-4">
                    <div className="flex justify-between text-xs text-gray-400 mb-1">
                        <span>ä»Šæ—¥æ”¶é›† ({Math.floor((data.profile.today_coins/target)*100)}%)</span>
                        {editingDaily ? <input type="number" className="w-12 bg-black text-white text-right" value={target} onChange={e=>setData(p=>({...p, profile: {...p.profile, custom_daily_target: Number(e.target.value)}}))} /> : <span className="text-white">{Math.floor(data.profile.today_coins)} / {target}</span>}
                    </div>
                    <div className="h-2 bg-black rounded-full overflow-hidden border border-white/10"><div className={`h-full transition-all duration-500 ${data.profile.today_coins >= target ? 'bg-green-500 shadow-[0_0_10px_#10B981]' : 'bg-blue-600'}`} style={{width: `${Math.min((data.profile.today_coins/target)*100, 100)}%`}}></div></div>
                </div>

                {/* Weekly Progress */}
                <div className="mb-4">
                    <div className="flex justify-between text-xs text-gray-400 mb-1">
                        <span>æœ¬é€±æ”¶é›†</span>
                        <span className="text-white">{Math.floor(data.profile.weekly_coins || 0)} / {weekTarget}</span>
                    </div>
                    <div className="h-1.5 bg-black rounded-full overflow-hidden border border-white/5"><div className="h-full bg-purple-500 transition-all duration-500" style={{width: `${Math.min(((data.profile.weekly_coins||0)/weekTarget)*100, 100)}%`}}></div></div>
                </div>

                {editingDaily && <input className="w-full bg-black/50 border border-white/10 rounded px-2 py-1 text-xs text-gray-300 mb-2" placeholder="ä»Šæ—¥å‚™è¨»..." value={data.profile.custom_daily_note || ""} onChange={e=>setData(p=>({...p, profile: {...p.profile, custom_daily_note: e.target.value}}))} />}

                {target > 0 ? (
                    <button onClick={handleCheckIn} disabled={data.profile.checked_in} className={`w-full py-2 rounded text-sm font-bold transition-all shadow-lg ${data.profile.checked_in ? 'bg-white/10 text-gray-500 cursor-not-allowed' : 'bg-gradient-to-r from-gold to-orange-600 text-black hover:brightness-110 hover:shadow-[0_0_15px_rgba(255,215,0,0.4)]'}`}>
                        {data.profile.checked_in ? <span><i className="fa-solid fa-check"></i> æœ¬æ—¥å·²ç°½åˆ°</span> : <span><i className="fa-solid fa-bolt"></i> æ³¨å…¥é­”åŠ›</span>}
                    </button>
                ) : <div className="text-center text-xs text-gray-500 py-2 border border-dashed border-white/10 rounded">ä»Šæ—¥ä¼‘æ¯</div>}
                
                <button onClick={endDay} className="w-full mt-3 py-2 bg-purple-900/50 hover:bg-purple-800 border border-purple-500/30 rounded text-purple-200 text-sm transition">ğŸŒ™ ä»Šæ—¥æ—…é€”çµç®—</button>
            </div>
            
            {/* å·¦ä¸‹è§’éŸ³é‡æ§åˆ¶ */}
            <div className="fixed bottom-4 left-4 z-50">
                    <button onClick={() => {
                        if(audioRef.current.paused) audioRef.current.play();
                        else audioRef.current.pause();
                    }} className="bg-black/50 p-2 rounded-full text-white hover:text-gold transition border border-white/10">
                    <i className="fa-solid fa-music"></i>
                    </button>
            </div>
        </div>
    );
};

        // --- âš›ï¸ ä¸»ç¨‹å¼ ---
        const App = () => {
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem("isekai_system_v28_daily");
                const parsed = saved ? JSON.parse(saved) : INITIAL_DATA;
                if(!parsed.rules) parsed.rules = DEFAULT_RULES;
                if(!parsed.daily_records) parsed.daily_records = {}; // Ensure compatibility
                return parsed;
            });
            const [activeTab, setActiveTab] = useState("calendar");
            const [toast, setToast] = useState(null);
            const [modal, setModal] = useState(null);
            const [started, setStarted] = useState(false);
            const [editingCurrency, setEditingCurrency] = useState(false);
            const audioRef = useRef(null);

            useEffect(() => { localStorage.setItem("isekai_system_v28_daily", JSON.stringify(data)); }, [data]);

            // --- ğŸ“… æ ¸å¿ƒä¿®å¾©ï¼šé‚è¼¯æ—¥æœŸè¨ˆç®— (Local Time Fix) ---
            const getLogicalDate = () => {
                const now = new Date();
                const resetHour = data.rules.reset_hour || 0;
                // å¦‚æœç›®å‰å°æ™‚å°æ–¼çµç®—å°æ™‚ï¼Œç®—ä½œå‰ä¸€å¤©
                if (now.getHours() < resetHour) {
                    now.setDate(now.getDate() - 1);
                }
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };

            // Daily & Weekly Reset Logic
            useEffect(() => {
                const logicalToday = getLogicalDate();
                if (data.profile.last_login !== logicalToday) {
                    const lastDate = new Date(data.profile.last_login);
                    const currDate = new Date(logicalToday);
                    
                    // Archive previous day record
                    const prevDateStr = data.profile.last_login;
                    const prevRecord = {
                        note: data.profile.custom_daily_note || "",
                        target: data.profile.custom_daily_target || data.rules.daily_target_def,
                        achieved: data.profile.today_coins
                    };

                    let newWeeklyCoins = data.profile.weekly_coins;
                    const dist = (currDate - lastDate) / (1000 * 60 * 60 * 24);
                    if (currDate.getDay() === 1 && data.profile.last_login !== logicalToday) {
                        newWeeklyCoins = 0;
                    } else if (dist > 7) {
                        newWeeklyCoins = 0;
                    }

                    setData(prev => ({
                        ...prev,
                        daily_records: { ...prev.daily_records, [prevDateStr]: prevRecord }, // Save archive
                        profile: {
                            ...prev.profile,
                            last_login: logicalToday,
                            today_coins: 0,
                            weekly_coins: newWeeklyCoins,
                            checked_in: false,
                            day_type: "ğŸ« ä¸Šå­¸æ—¥",
                            custom_daily_target: null, // Reset daily target
                            custom_daily_note: "" // Reset daily note
                        }
                    }));
                    if(data.setupComplete) setModal({ type: 'daily_welcome' });
                }
            }, [data.rules.reset_hour]);

            useEffect(() => {
                if(audioRef.current && started) {
                    audioRef.current.volume = data.rules.music_volume || 0.3;
                    if(data.rules.music_url && audioRef.current.src !== data.rules.music_url) {
                        audioRef.current.src = data.rules.music_url;
                        audioRef.current.play().catch(e => console.log("Audio prevented", e));
                    }
                }
            }, [data.rules.music_url, data.rules.music_volume, started]);

            const startSystem = () => {
                setStarted(true);
                soundEngine.init();
                soundEngine.playFanfare();
                if(audioRef.current && data.rules.music_url) audioRef.current.play();
            };

            const showToast = (msg, icon="check") => {
                setToast({ msg, icon });
                if(icon.includes("check") || icon.includes("coins") || icon.includes("gift")) soundEngine.playSFX('money');
                else soundEngine.playSFX('error');
                setTimeout(() => setToast(null), 3000);
            };

            const getTitleData = () => {
                const xp = data.profile.coins_mithril;
                let idx = 0;
                for(let i = 0; i < data.titles.length; i++) {
                    if(xp >= data.titles[i].req) idx = i; else break;
                }
                const current = data.titles[idx];
                const next = data.titles[idx + 1] || { name: "å·²é”é ‚å³°", req: xp };
                let progress = next.name !== "å·²é”é ‚å³°" ? Math.min(100, Math.max(0, ((xp - current.req) / (next.req - current.req)) * 100)) : 100;
                return { current: current.name, next: next.name, progress, level: idx + 1, idx, nextReq: next.req };
            };
            const titleData = getTitleData();

            // --- ğŸ“… Tab 1: æ™‚å…‰ç¹”éŒ¦ ---
            const CalendarView = () => {
                const [viewDate, setViewDate] = useState(new Date());
                const year = viewDate.getFullYear();
                const month = viewDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const offset = new Date(year, month, 1).getDay() === 0 ? 6 : new Date(year, month, 1).getDay() - 1;

                const getDayData = (day) => {
                    const dStr = String(day).padStart(2, '0');
                    const mStr = String(month + 1).padStart(2, '0');
                    const dateStr = `${year}-${mStr}-${dStr}`;
                    let income = 0;
                    let logs = [];
                    data.adventure_log.forEach(h => {
                        if ((h.date === dateStr) && h.type === 'income') {
                            const match = h.cost.match(/(\d+(\.\d+)?)ç§˜/);
                            if(match) income += parseFloat(match[1]);
                            logs.push(h);
                        }
                    });
                    const ddls = data.goals.filter(g => g.deadline === dateStr);
                    const checkedIn = data.profile.check_in_history.includes(dateStr);
                    const dailyRecord = data.daily_records[dateStr]; // Fetch archived note
                    return { dateStr, income, logs, ddls, checkedIn, dailyRecord };
                };

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="flex justify-between items-center bg-black/60 p-4 rounded-xl border border-gold/30 shadow-lg">
                            <button onClick={() => { setViewDate(new Date(year, month - 1, 1)); soundEngine.playSFX('click'); }} className="text-gold hover:text-white p-2"><i className="fa-solid fa-chevron-left fa-lg"></i></button>
                            <h2 className="text-3xl font-fantasy text-gold-glow tracking-widest flex items-center gap-2">
                                <i className="fa-solid fa-calendar-days text-accent"></i> {year} å¹´ {month + 1} æœˆ
                            </h2>
                            <button onClick={() => { setViewDate(new Date(year, month + 1, 1)); soundEngine.playSFX('click'); }} className="text-gold hover:text-white p-2"><i className="fa-solid fa-chevron-right fa-lg"></i></button>
                        </div>

                        <div className="grid grid-cols-7 gap-3">
                            {['MON','TUE','WED','THU','FRI','SAT','SUN'].map(d => <div key={d} className="text-center text-gray-400 font-bold uppercase tracking-wider">{d}</div>)}
                            {Array(offset).fill(null).map((_, i) => <div key={`e-${i}`}></div>)}
                            {Array(daysInMonth).fill(null).map((_, i) => {
                                const day = i + 1;
                                const info = getDayData(day);
                                const isToday = info.dateStr === getLogicalDate();
                                return (
                                    <div key={day} onClick={() => { setModal({ type: 'day_detail', data: info }); soundEngine.playSFX('click'); }}
                                        className={`h-32 arcane-panel p-2 cursor-pointer group transition-all duration-300 hover:scale-[1.05]
                                            ${isToday ? 'border-gold bg-gold/10 shadow-[0_0_20px_rgba(255,215,0,0.3)]' : 'border-white/10 hover:border-gold/50'}
                                        `}>
                                        <div className="flex justify-between items-center mb-1">
                                            <span className={`font-bold text-xl ${isToday ? 'text-gold' : 'text-gray-400'}`}>{day}</span>
                                            {info.checkedIn && <i className="fa-solid fa-circle-check text-green-400 text-lg animate-pulse"></i>}
                                        </div>
                                        <div className="space-y-1 overflow-hidden">
                                            {info.ddls.map((g, idx) => (
                                                <div key={idx} className="text-[10px] bg-red-900/60 text-red-100 px-1 rounded border border-red-500/30 truncate">ğŸ¯ {g.name}</div>
                                            ))}
                                            {info.income > 0 && <div className="text-xs text-blue-300 font-mono flex items-center gap-1"><i className="fa-solid fa-gem text-[10px]"></i> +{Math.floor(info.income)}</div>}
                                            {/* Show icon if note exists */}
                                            {info.dailyRecord?.note && <div className="text-[9px] text-yellow-500"><i className="fa-solid fa-note-sticky"></i> æœ‰å‚™è¨»</div>}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            // --- ğŸ”­ Tab 2: å‘½é€”æ˜Ÿåœ– ---
            const GoalView = () => {
                const [viewMode, setViewMode] = useState('kanban'); 
                const [newGoal, setNewGoal] = useState({ subject: "", name: "", priority: "Medium", status: "é€²è¡Œä¸­", deadline: new Date().toISOString().split('T')[0] });
                const [isEditingSubject, setIsEditingSubject] = useState(false);
                const [newSubjName, setNewSubjName] = useState("");

                const addGoal = () => {
                    if(!newGoal.name) return showToast("è«‹è¼¸å…¥ç›®æ¨™åç¨±", "exclamation");
                    const subj = newGoal.subject || "æœªåˆ†é¡";
                    if(!data.subjects.includes(subj)) setData(p => ({...p, subjects: [...p.subjects, subj]}));
                    setData(p => ({ ...p, goals: [...p.goals, { id: Date.now(), ...newGoal, subject: subj }] }));
                    setNewGoal({ ...newGoal, name: "" });
                    soundEngine.playSFX('success');
                };

                const updateGoal = (id, field, val) => setData(p => ({ ...p, goals: p.goals.map(g => g.id === id ? { ...g, [field]: val } : g) }));
                const deleteGoal = (id) => confirm("åˆªé™¤ï¼Ÿ") && setData(p => ({...p, goals: p.goals.filter(g => g.id !== id)}));
                const toggleStatus = (id) => setData(p => ({ ...p, goals: p.goals.map(g => g.id === id ? { ...g, status: g.status === "å·²å®Œæˆ" ? "é€²è¡Œä¸­" : "å·²å®Œæˆ" } : g) }));

                const addSubject = () => {
                    if(newSubjName && !data.subjects.includes(newSubjName)) {
                        setData(p => ({...p, subjects: [...p.subjects, newSubjName]}));
                        setNewSubjName("");
                    }
                };

                const deleteSubject = (sub) => {
                    if(confirm(`ç¢ºå®šåˆªé™¤ç§‘ç›®ã€Œ${sub}ã€ï¼Ÿ`)) {
                        setData(p => ({...p, subjects: p.subjects.filter(s => s !== sub)}));
                    }
                };

                return (
                    <div className="space-y-6">
                        <div className="flex flex-wrap justify-between items-center bg-black/40 p-4 rounded-xl border border-white/10 gap-4">
                            <h3 className="text-2xl font-fantasy text-gold-glow flex items-center gap-2"><i className="fa-solid fa-compass"></i> å‘½é€”æ˜Ÿåœ–</h3>
                            <div className="flex gap-2">
                                <button onClick={() => setViewMode('kanban')} className={`px-4 py-2 rounded font-bold ${viewMode==='kanban' ? 'bg-accent text-white' : 'bg-slate-800 text-gray-400'}`}><i className="fa-solid fa-columns"></i> çœ‹æ¿</button>
                                <button onClick={() => setViewMode('calendar')} className={`px-4 py-2 rounded font-bold ${viewMode==='calendar' ? 'bg-accent text-white' : 'bg-slate-800 text-gray-400'}`}><i className="fa-solid fa-calendar-check"></i> æˆªæ­¢</button>
                                <button onClick={() => setIsEditingSubject(!isEditingSubject)} className={`px-4 py-2 rounded font-bold ${isEditingSubject ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-gray-300'}`}><i className="fa-solid fa-book"></i> ç§‘ç›®ç®¡ç†</button>
                            </div>
                        </div>

                        {isEditingSubject && (
                            <div className="arcane-panel p-4 mb-4">
                                <div className="flex gap-2 mb-4">
                                    <input className="magic-input p-2 rounded" placeholder="æ–°ç§‘ç›®åç¨±" value={newSubjName} onChange={e => setNewSubjName(e.target.value)} />
                                    <button onClick={addSubject} className="btn-primary px-4 rounded">æ–°å¢</button>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    {data.subjects.map(s => (
                                        <div key={s} className="bg-slate-800 px-3 py-1 rounded border border-white/10 text-sm flex items-center gap-2 pr-1 relative group">
                                            {s} 
                                            <button 
                                                onClick={(e) => { 
                                                    e.preventDefault();
                                                    e.stopPropagation(); 
                                                    deleteSubject(s); 
                                                }} 
                                                className="w-6 h-6 flex items-center justify-center bg-red-500/20 hover:bg-red-600 text-red-400 hover:text-white rounded-full transition-colors cursor-pointer relative z-50 ml-1"
                                                title="åˆªé™¤"
                                            >
                                                <i className="fa-solid fa-xmark text-xs pointer-events-none"></i>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="arcane-panel p-4 flex flex-wrap gap-2 items-center">
                            <select className="magic-input p-2 rounded w-32" value={newGoal.subject} onChange={e => setNewGoal({...newGoal, subject: e.target.value})}>
                                <option value="">ç§‘ç›®...</option>
                                {data.subjects.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                            <input className="magic-input p-2 rounded flex-1" placeholder="æ–°ç›®æ¨™åç¨±..." value={newGoal.name} onChange={e => setNewGoal({...newGoal, name: e.target.value})} />
                            <select className="magic-input p-2 rounded" value={newGoal.priority} onChange={e => setNewGoal({...newGoal, priority: e.target.value})}>
                                <option value="High">ğŸ”´ ç·Šæ€¥</option><option value="Medium">ğŸŸ¡ æ™®é€š</option><option value="Low">ğŸŸ¢ æš«ç·©</option>
                            </select>
                            <input type="date" className="magic-input p-2 rounded" value={newGoal.deadline} onChange={e => setNewGoal({...newGoal, deadline: e.target.value})} />
                            <button onClick={addGoal} className="btn-primary px-4 py-2 rounded font-bold"><i className="fa-solid fa-plus"></i></button>
                        </div>

                        {viewMode === 'kanban' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {[...new Set([...data.subjects, ...data.goals.map(g => g.subject)])].map(subj => (
                                    <div key={subj} className="arcane-panel p-4 flex flex-col gap-3">
                                        <h4 className="text-gold font-bold border-b border-white/10 pb-2 mb-2">{subj}</h4>
                                        {data.goals.filter(g => g.subject === subj).map(g => (
                                            <div key={g.id} className={`p-3 rounded bg-black/40 border border-white/5 hover:border-gold/30 transition flex justify-between items-center group ${g.status === 'å·²å®Œæˆ' ? 'opacity-50' : ''}`}>
                                                <div className="flex-1 mr-2">
                                                    <input className="bg-transparent font-bold w-full outline-none text-white" value={g.name} onChange={e => updateGoal(g.id, 'name', e.target.value)} />
                                                    <div className="text-xs text-gray-400">{g.deadline}</div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => { toggleStatus(g.id); soundEngine.playSFX('success'); }} className="text-green-400 hover:text-green-300"><i className={`fa-solid ${g.status==='å·²å®Œæˆ'?'fa-rotate-left':'fa-check'}`}></i></button>
                                                    <button onClick={() => deleteGoal(g.id)} className="text-red-400 opacity-0 group-hover:opacity-100 transition"><i className="fa-solid fa-trash"></i></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {viewMode === 'calendar' && (
                            <div className="arcane-panel p-6 space-y-2">
                                {data.goals.sort((a,b) => new Date(a.deadline) - new Date(b.deadline)).map(g => (
                                    <div key={g.id} className="flex items-center gap-4 p-3 bg-black/40 rounded border border-white/5">
                                        <div className={`w-2 h-10 rounded ${g.priority==='High'?'bg-red-500':g.priority==='Medium'?'bg-yellow-500':'bg-green-500'}`}></div>
                                        <div className="flex-1">
                                            <span className="text-xs bg-slate-700 px-2 rounded text-gray-300 mr-2">{g.subject}</span>
                                            <span className={`font-bold ${g.status==='å·²å®Œæˆ' ? 'line-through text-gray-500' : 'text-white'}`}>{g.name}</span>
                                            <span className="text-xs text-gray-400 ml-2"><i className="fa-regular fa-clock"></i> {g.deadline}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            // --- âš”ï¸ Tab 3: å¾é€”ç¹ªå· ---
            const TaskView = () => {
                const [newTask, setNewTask] = useState({ name: "", goal: "", est: 30, diff: "ç°¡å–®", hate: false, notes: "" });
                const [completeModal, setCompleteModal] = useState(null);
                const [finalNotes, setFinalNotes] = useState("");

                const getRewardPreview = () => {
                    const diffBonus = { "ç°¡å–®": data.rules.diff_easy, "ä¸­ç­‰": data.rules.diff_med, "å›°é›£": data.rules.diff_hard, "æ¥µé›£": data.rules.diff_ext }[newTask.diff] || 5;
                    let mithril = Number((newTask.est * diffBonus * data.rules.money_per_min).toFixed(1));
                    if (newTask.hate) mithril = Number((mithril * data.rules.hate_mult).toFixed(1));
                    return mithril;
                };

                const addTask = () => {
                    if (!newTask.name) { soundEngine.playSFX('error'); return showToast("å…§å®¹ä¸èƒ½ç‚ºç©º", "triangle-exclamation"); }
                    setData(p => ({...p, tasks: [...p.tasks, { id: Date.now(), ...newTask, status: 'active', date: getLogicalDate() }]}));
                    setNewTask({ ...newTask, name: "", notes: "" }); 
                    showToast("å§”è¨—å·²ç™¼å¸ƒ", "scroll");
                };

                const handleComplete = (taskId, total, focus) => {
                    const task = data.tasks.find(t => t.id === taskId);
                    const rate = { "ç°¡å–®": data.rules.diff_easy, "ä¸­ç­‰": data.rules.diff_med, "å›°é›£": data.rules.diff_hard, "æ¥µé›£": data.rules.diff_ext }[task.diff] || 5;
                    let mithril = Number(((focus / 30) * rate * data.rules.money_per_min).toFixed(1));
                    if (task.hate) mithril = Number((mithril * data.rules.hate_mult).toFixed(1));
                    
                    let soul = (task.diff === "å›°é›£" ? 1 : (task.diff === "æ¥µé›£" ? 2 : 0));
                    let star = focus >= data.rules.star_threshold ? Math.floor(focus / 60) : 0;
                    const rewardStr = `+${mithril}ç§˜` + (soul ? ` +${soul}éˆ` : '') + (star ? ` +${star}æ˜Ÿ` : '');
                    const todayStr = getLogicalDate();

                    setData(prev => ({
                        ...prev,
                        profile: {
                            ...prev.profile,
                            coins_mithril: prev.profile.coins_mithril + mithril,
                            coins_soul: prev.profile.coins_soul + soul,
                            coins_star: prev.profile.coins_star + star,
                            today_coins: prev.profile.today_coins + mithril,
                            weekly_coins: prev.profile.weekly_coins + mithril
                        },
                        tasks: prev.tasks.filter(t => t.id !== taskId),
                        adventure_log: [{ 
                            date: todayStr, 
                            displayDate: new Date().toLocaleString(), 
                            item: `å®Œæˆ: ${task.name}`, 
                            cost: rewardStr, 
                            type: 'income',
                            details: `ç¸½:${total}åˆ† / å°ˆæ³¨:${focus}åˆ† / ${finalNotes || 'ç„¡å‚™è¨»'}`,
                            subject: task.goal || "é›œé …",
                            rawMithril: mithril
                        }, ...prev.adventure_log]
                    }));
                    setCompleteModal(null);
                    setFinalNotes("");
                    soundEngine.playFanfare();
                    showToast(`ç²å¾— ${mithril} ç§˜éŠ€`, "coins");
                };

                return (
                    <div className="space-y-6">
                        <div className="arcane-panel p-6 border-t-2 border-accent">
                            <h3 className="text-xl font-fantasy text-white mb-4"><i className="fa-solid fa-scroll text-accent"></i> ç™¼å¸ƒæ–°å§”è¨—</h3>
                            <div className="grid grid-cols-1 md:grid-cols-12 gap-3 mb-4">
                                <input className="md:col-span-4 magic-input p-3 rounded" placeholder="ä»»å‹™å…§å®¹..." value={newTask.name} onChange={e => setNewTask({...newTask, name: e.target.value})} />
                                <select className="md:col-span-3 magic-input p-3 rounded" value={newTask.goal} onChange={e => setNewTask({...newTask, goal: e.target.value})}>
                                    <option value="">(é—œè¯ç›®æ¨™)</option>
                                    {data.goals.map(g => <option key={g.id} value={g.name}>{g.name}</option>)}
                                </select>
                                <input type="number" className="md:col-span-2 magic-input p-3 rounded" placeholder="é è¨ˆ(åˆ†)" value={newTask.est} onChange={e => setNewTask({...newTask, est: Number(e.target.value)})} />
                                <select className="md:col-span-2 magic-input p-3 rounded" value={newTask.diff} onChange={e => setNewTask({...newTask, diff: e.target.value})}>
                                    {["ç°¡å–®", "ä¸­ç­‰", "å›°é›£", "æ¥µé›£"].map(d => <option key={d} value={d}>{d}</option>)}
                                </select>
                                <label className="md:col-span-1 flex items-center justify-center bg-red-900/30 rounded border border-red-500/30 text-xs text-red-300">
                                    <input type="checkbox" className="mr-1" checked={newTask.hate} onChange={e => setNewTask({...newTask, hate: e.target.checked})} /> å­æƒ¡
                                </label>
                            </div>
                            <div className="flex justify-between items-center bg-black/40 p-2 rounded text-sm text-gray-400 mb-2">
                                <span>å…¬å¼: å°ˆæ³¨æ™‚é–“ Ã— é›£åº¦ä¿‚æ•¸</span>
                                <span className="text-gold font-bold">é è¨ˆ: {getRewardPreview()} ç§˜éŠ€</span>
                            </div>
                            <button onClick={addTask} className="w-full btn-primary py-2 rounded font-bold">ç™¼å¸ƒå§”è¨—</button>
                        </div>

                        <div className="space-y-3">
                            {data.tasks.map(task => (
                                <div key={task.id} className="arcane-panel p-4 flex flex-col md:flex-row justify-between items-center gap-4">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                            <span className={`px-2 py-0.5 text-xs rounded border ${task.diff.includes('é›£')?'border-red-500 text-red-400':'border-green-500 text-green-400'}`}>{task.diff}</span>
                                            <h4 className="font-bold text-lg text-white">{task.name}</h4>
                                            {task.hate && <span className="text-[10px] bg-red-900 px-2 rounded text-white">å­æƒ¡</span>}
                                        </div>
                                        <p className="text-sm text-gray-400 mt-1">ğŸ¯ {task.goal||"ç„¡"} | â³ é è¨ˆ {task.est} åˆ†</p>
                                    </div>
                                    <button onClick={() => setCompleteModal(task.id)} className="px-4 py-2 bg-green-700 hover:bg-green-600 text-white rounded font-bold shadow-lg">å›å ±æˆæœ</button>
                                    <button onClick={() => setData(p => ({...p, tasks: p.tasks.filter(t => t.id !== task.id)}))} className="text-red-400 px-2"><i className="fa-solid fa-trash"></i></button>
                                </div>
                            ))}
                        </div>

                        {completeModal && (
                            <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={() => setCompleteModal(null)}>
                                <div className="arcane-panel p-6 max-w-sm w-full" onClick={e => e.stopPropagation()}>
                                    <h3 className="text-xl font-bold text-white mb-4">ä»»å‹™çµç®—</h3>
                                    <div className="space-y-3">
                                        <div><label className="text-xs text-gray-400">å¯¦éš›ç¸½è€—æ™‚ (åˆ†)</label><input type="number" id="totalTime" className="magic-input w-full p-2 rounded" defaultValue={data.tasks.find(t=>t.id===completeModal).est} /></div>
                                        <div><label className="text-xs text-gold">å¯¦éš›å°ˆæ³¨æ™‚é–“ (åˆ†) - çå‹µä¾æ“š</label><input type="number" id="focusTime" className="magic-input w-full p-2 rounded border-gold/50" defaultValue={data.tasks.find(t=>t.id===completeModal).est} /></div>
                                        <div><label className="text-xs text-gray-400">çµç®—å‚™è¨» (å¿ƒå¾—/ç´°ç¯€)</label><textarea className="magic-input w-full p-2 rounded" rows="2" value={finalNotes} onChange={e => setFinalNotes(e.target.value)}></textarea></div>
                                        <button onClick={() => handleComplete(completeModal, Number(document.getElementById('totalTime').value), Number(document.getElementById('focusTime').value))} className="w-full py-2 bg-green-600 rounded font-bold mt-2">ç¢ºèªé ˜è³</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // --- ğŸ“œ Tab 4: å†’éšªæ‰‹æœ­ (Log) ---
            const AdventureLogView = () => {
                const [view, setView] = useState('daily'); 
                
                const revertLog = (idx) => {
                    const log = data.adventure_log[idx];
                    if(!log || !confirm("ç¢ºå®šæ’¤éŠ·æ­¤ç´€éŒ„ï¼Ÿçå‹µå°‡è¢«æ‰£é™¤ã€‚")) return;
                    let newProfile = {...data.profile};
                    if(log.rawMithril) {
                         newProfile.coins_mithril -= log.rawMithril;
                         newProfile.today_coins -= log.rawMithril;
                         newProfile.weekly_coins -= log.rawMithril;
                    }
                    const newLog = [...data.adventure_log];
                    newLog.splice(idx, 1);
                    setData(p => ({...p, profile: newProfile, adventure_log: newLog}));
                    showToast("ç´€éŒ„å·²æ’¤éŠ·", "rotate-left");
                };

                const groupedBySubject = {};
                data.adventure_log.forEach(l => {
                    const subj = l.subject || "æœªåˆ†é¡";
                    if(!groupedBySubject[subj]) groupedBySubject[subj] = { totalTime: 0, logs: [] };
                    const timeMatch = l.details && l.details.match(/å°ˆæ³¨:(\d+)/);
                    if(timeMatch) groupedBySubject[subj].totalTime += parseInt(timeMatch[1]);
                    groupedBySubject[subj].logs.push(l);
                });

                return (
                    <div className="space-y-6">
                        <div className="flex gap-4 border-b border-white/10 pb-4">
                            <button onClick={() => setView('daily')} className={`text-lg font-bold ${view==='daily'?'text-gold border-b-2 border-gold':'text-gray-400'}`}>ğŸ“… æ¯æ—¥è¶³è·¡</button>
                            <button onClick={() => setView('project')} className={`text-lg font-bold ${view==='project'?'text-gold border-b-2 border-gold':'text-gray-400'}`}>ğŸ“‚ å°ˆæ¡ˆæ­¸æª”</button>
                        </div>
                        
                        <div className="arcane-panel p-6 h-[600px] overflow-y-auto">
                            {view === 'daily' && data.adventure_log.map((h, i) => (
                                <div key={i} className="p-3 bg-black/30 rounded border border-white/5 hover:border-gold/30 transition mb-2 flex justify-between items-start">
                                    <div className="flex-1">
                                        <div className="font-bold text-white">{h.item} <span className="text-green-400 font-mono ml-2">{h.cost}</span></div>
                                        <div className="text-xs text-gray-400 mt-1">
                                            <span className="bg-slate-700 px-1 rounded mr-2">{h.subject}</span> 
                                            {h.details} | {h.displayDate || h.date}
                                        </div>
                                    </div>
                                    <button onClick={() => revertLog(i)} className="text-gray-600 hover:text-red-500 px-2 py-1"><i className="fa-solid fa-rotate-left"></i> æ’¤éŠ·</button>
                                </div>
                            ))}

                            {view === 'project' && Object.entries(groupedBySubject).map(([subj, data]) => (
                                <div key={subj} className="mb-6">
                                    <h4 className="text-gold font-bold mb-2 border-b border-white/10">{subj} <span className="text-xs text-gray-400 ml-2">(ç´¯è¨ˆå°ˆæ³¨: {data.totalTime} åˆ†é˜)</span></h4>
                                    {data.logs.map((h, i) => (
                                        <div key={i} className="text-sm text-gray-300 ml-4 mb-1 flex justify-between">
                                            <span>{h.item}</span>
                                            <span className="text-xs text-gray-500">{h.details}</span>
                                        </div>
                                    ))}
                                </div>
                            ))}
                            {data.adventure_log.length === 0 && <div className="text-gray-500 text-center">æš«ç„¡ç´€éŒ„</div>}
                        </div>
                    </div>
                );
            };

            // --- ğŸª Tab 5: ç¥•æ³•é›†å¸‚ ---
            const ShopView = () => {
                const [activeSubTab, setActiveSubTab] = useState('market'); 
                const [editMode, setEditMode] = useState(false);
                const [newItem, setNewItem] = useState({ name: "", cost: 100, currency: "mithril", desc: "" });

                const buy = (item) => {
                    const key = `coins_${item.currency}`;
                    const currentBalance = Number(data.profile[key]);
                    const itemCost = Number(item.cost);

                    if(currentBalance >= itemCost) {
                        if(confirm(`è³¼è²· ${item.name}?`)) {
                            const newInv = { ...data.inventory };
                            newInv[item.id] = (newInv[item.id] || 0) + 1;
                            setData(prev => ({
                                ...prev,
                                profile: { ...prev.profile, [key]: currentBalance - itemCost },
                                inventory: newInv,
                                history: [{ date: new Date().toLocaleString(), item: `è³¼è²·: ${item.name}`, cost: `-${itemCost} ${item.currency}`, type: 'expense' }, ...prev.history]
                            }));
                            showToast("äº¤æ˜“æˆåŠŸ", "gift");
                        }
                    } else showToast("é¤˜é¡ä¸è¶³", "ban");
                };

                const updateShopItem = (id, field, val) => {
                    setData(p => ({...p, shop: p.shop.map(i => i.id === id ? { ...i, [field]: val } : i)}));
                };

                const addItem = () => {
                    setData(p => ({...p, shop: [...p.shop, {id: Date.now(), ...newItem}]}));
                    setNewItem({ name: "", cost: 100, currency: "mithril", desc: "" });
                    soundEngine.playSFX('success');
                };

                const useItem = (itemId) => {
                    const item = data.shop.find(i => i.id == itemId);
                    if(!item) return;
                    if(item.effect === 'rest_day') {
                        setData(p => ({ ...p, profile: { ...p.profile, day_type: "ğŸ–ï¸ å‡æœŸ", custom_daily_target: 0 } }));
                        showToast("å·²ä½¿ç”¨ä¼‘æ¯å·ï¼ä»Šæ—¥ç›®æ¨™æ­¸é›¶", "umbrella-beach");
                    } else {
                        showToast("é“å…·å·²ä½¿ç”¨", "magic");
                    }
                    const newInv = { ...data.inventory };
                    newInv[itemId]--;
                    if(newInv[itemId] <= 0) delete newInv[itemId];
                    setData(p => ({ ...p, inventory: newInv }));
                };

                return (
                    <div className="space-y-6">
                        <div className="flex gap-4 border-b border-white/10 pb-4 justify-between">
                            <div className="flex gap-4">
                                <button onClick={() => setActiveSubTab('market')} className={`text-xl font-bold ${activeSubTab==='market' ? 'text-gold border-b-2 border-gold' : 'text-gray-400'}`}>ç¥•æ³•é›†å¸‚</button>
                                <button onClick={() => setActiveSubTab('inventory')} className={`text-xl font-bold ${activeSubTab==='inventory' ? 'text-gold border-b-2 border-gold' : 'text-gray-400'}`}>æˆ‘çš„èƒŒåŒ…</button>
                            </div>
                            <button onClick={() => setEditMode(!editMode)} className="text-gray-500 text-sm">ğŸ› ï¸ è€é—†æ¨¡å¼</button>
                        </div>

                        {activeSubTab === 'market' && (
                            <div>
                                {editMode && (
                                    <div className="arcane-panel p-4 mb-4 border-dashed border-gold/30">
                                        <div className="flex gap-2">
                                            <input className="magic-input p-2 rounded" placeholder="å•†å“å" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} />
                                            <input className="magic-input p-2 rounded w-24" type="number" placeholder="åƒ¹æ ¼" value={newItem.cost} onChange={e => setNewItem({...newItem, cost: Number(e.target.value)})} />
                                            <button onClick={addItem} className="btn-primary px-4 rounded">ä¸Šæ¶</button>
                                        </div>
                                    </div>
                                )}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {data.shop.map(item => (
                                        <div key={item.id} className="arcane-panel relative group h-56 flex flex-col justify-between p-5">
                                            <div className="relative z-10">
                                                {editMode ? (
                                                    <>
                                                        <input className="bg-transparent border-b border-white/20 w-full mb-1 text-white font-bold" value={item.name} onChange={e => updateShopItem(item.id, 'name', e.target.value)} />
                                                        <textarea className="bg-transparent border border-white/10 w-full text-xs text-gray-400 h-16 resize-none" value={item.desc} onChange={e => updateShopItem(item.id, 'desc', e.target.value)} />
                                                    </>
                                                ) : (
                                                    <>
                                                        <div className="font-bold text-white text-lg mb-1">{item.name}</div>
                                                        <div className="text-sm text-gray-400 h-12 overflow-hidden">{item.desc}</div>
                                                    </>
                                                )}
                                            </div>
                                            
                                            <div className="flex justify-between items-end relative z-20 pt-2 border-t border-white/5">
                                                <div className={`font-bold text-lg ${CURRENCIES[item.currency].color} flex items-center gap-1`}>
                                                    {editMode ? <input type="number" className="w-16 bg-black text-white" value={item.cost} onChange={e=>updateShopItem(item.id, 'cost', Number(e.target.value))} /> : item.cost} 
                                                    <i className={`fa-solid ${CURRENCIES[item.currency].icon}`}></i>
                                                </div>
                                                
                                                {editMode ? (
                                                    <button onClick={() => setData(p => ({...p, shop: p.shop.filter(i => i.id !== item.id)}))} className="text-red-400 hover:text-red-200 z-50 cursor-pointer relative"><i className="fa-solid fa-trash"></i></button>
                                                ) : (
                                                    // FIX: Highest Z-Index for Buy Button
                                                    <button 
                                                        onClick={(e) => { 
                                                            e.stopPropagation(); 
                                                            e.preventDefault(); 
                                                            buy(item); 
                                                        }} 
                                                        className="relative z-50 bg-gradient-to-r from-gold/20 to-gold/40 hover:from-gold hover:to-yellow-300 hover:text-black border border-gold/50 text-gold px-6 py-2 rounded-full font-bold shadow-lg transition-all active:scale-95 cursor-pointer pointer-events-auto"
                                                    >
                                                        è³¼è²·
                                                    </button>
                                                )}
                                            </div>
                                            <div className="absolute top-2 right-2 text-xs text-gray-500 z-10">å·²æŒæœ‰: {data.inventory[item.id] || 0}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeSubTab === 'inventory' && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {Object.keys(data.inventory).length > 0 ? Object.entries(data.inventory).map(([id, count]) => {
                                    const item = data.shop.find(i => i.id == id) || { name: "æœªçŸ¥ç‰©å“", desc: "" };
                                    return (
                                        <div key={id} className="arcane-panel p-4 flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-white">{item.name}</div>
                                                <div className="text-xs text-gray-400">æŒæœ‰: {count}</div>
                                            </div>
                                            <button onClick={() => useItem(id)} className="px-3 py-1 bg-purple-600 hover:bg-purple-500 rounded text-sm text-white">ä½¿ç”¨</button>
                                        </div>
                                    );
                                }) : <div className="text-gray-500 col-span-3 text-center py-10">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</div>}
                            </div>
                        )}
                    </div>
                );
            };

            // --- ğŸª™ Tab 6: äº¤æ˜“ç´€å¹´ (History) ---
            const HistoryView = () => (
                <div className="arcane-panel p-6 h-[600px] overflow-y-auto">
                    <h3 className="text-xl font-title text-fantasy mb-4">äº¤æ˜“ç´€å¹´ (è³¼è²·ç´€éŒ„)</h3>
                    <div className="space-y-2">
                        {data.history.map((h, i) => (
                            <div key={i} className="flex justify-between p-3 bg-black/30 rounded border border-white/5">
                                <div><div className="text-gray-200">{h.item}</div><div className="text-xs text-gray-500">{h.date}</div></div>
                                <div className="font-mono font-bold text-red-400">{h.cost}</div>
                            </div>
                        ))}
                        {data.history.length === 0 && <div className="text-gray-500 text-center">ç„¡äº¤æ˜“ç´€éŒ„</div>}
                    </div>
                </div>
            );

            // --- ğŸŒŒ Tab 7: æ˜Ÿç©¹æ®¿å ‚ (Hall) ---
            const HallView = () => {
                const [newAchv, setNewAchv] = useState({ name: "", desc: "", reward: 10, currency: "seed" });
                const toggleAchv = (id) => {
                    const updated = data.achievements.map(a => {
                        if(a.id === id) {
                            if(!a.completed) {
                                setData(prev => ({
                                    ...prev,
                                    profile: { ...prev.profile, [`coins_${a.currency}`]: prev.profile[`coins_${a.currency}`] + a.reward },
                                    adventure_log: [{ date: getLogicalDate(), displayDate: new Date().toLocaleString(), item: `æˆå°±: ${a.name}`, cost: `+${a.reward}å•Ÿ`, type: 'income', details: 'æˆå°±è§£é–' }, ...prev.adventure_log]
                                }));
                                soundEngine.playFanfare();
                                showToast("æ¦®è€€è§£é–ï¼", "trophy");
                            }
                            return { ...a, completed: !a.completed };
                        }
                        return a;
                    });
                    setData(prev => ({ ...prev, achievements: updated }));
                };
                const addAchv = () => {
                    if(!newAchv.name) return;
                    setData(p => ({...p, achievements: [...p.achievements, { id: Date.now(), ...newAchv, completed: false }]}));
                    setNewAchv({ name: "", desc: "", reward: 10, currency: "seed" });
                };

                return (
                    <div className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div className="arcane-panel p-4 border-t-2 border-blue-500"><h4 className="text-blue-300 text-xs mb-1 font-bold">ç§˜éŠ€å„²é‡</h4><div className="text-3xl font-bold font-mono">{Math.floor(data.profile.coins_mithril)}</div></div>
                            <div className="arcane-panel p-4 border-t-2 border-purple-500"><h4 className="text-purple-300 text-xs mb-1 font-bold">å®Œæˆä»»å‹™</h4><div className="text-3xl font-bold font-mono">{data.adventure_log.length}</div></div>
                            <div className="arcane-panel p-4 border-t-2 border-gold"><h4 className="text-gold text-xs mb-1 font-bold">ç›®å‰å¢ƒç•Œ</h4><div className="text-xl font-bold font-title">{titleData.current}</div></div>
                        </div>
                        <div className="arcane-panel p-6">
                            <h3 className="text-xl font-title text-gold mb-4"><i className="fa-solid fa-trophy"></i> æ¦®è€€åˆ»å° (æˆå°±ç®¡ç†)</h3>
                            <div className="flex flex-wrap gap-2 mb-6 bg-black/30 p-3 rounded-xl border border-white/5">
                                <input className="magic-input p-2 rounded flex-1" placeholder="æˆå°±åç¨±" value={newAchv.name} onChange={e => setNewAchv({...newAchv, name: e.target.value})} />
                                <input className="magic-input p-2 rounded flex-[2]" placeholder="æè¿°" value={newAchv.desc} onChange={e => setNewAchv({...newAchv, desc: e.target.value})} />
                                <input className="magic-input p-2 rounded w-20 text-center" type="number" value={newAchv.reward} onChange={e => setNewAchv({...newAchv, reward: Number(e.target.value)})} />
                                <button onClick={addAchv} className="bg-green-700 px-4 rounded text-white">æ–°å¢</button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[400px] overflow-y-auto">
                                {data.achievements.map(achv => (
                                    <div key={achv.id} className={`p-4 rounded-xl border flex justify-between items-center transition-all ${achv.completed ? 'bg-green-900/20 border-green-500/50' : 'bg-black/30 border-white/10'}`}>
                                        <div><div className={`font-bold ${achv.completed ? 'text-green-400' : 'text-gray-300'}`}>{achv.name}</div><div className="text-sm text-gray-500">{achv.desc}</div><div className="text-xs text-gold mt-1">çå‹µ: {achv.reward}</div></div>
                                        <button onClick={() => toggleAchv(achv.id)} className={`text-2xl ${achv.completed ? 'text-green-400' : 'text-gray-600'}`}><i className={`fa-regular ${achv.completed ? 'fa-square-check' : 'fa-square'}`}></i></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            // --- âš™ï¸ Tab 8: ç³»çµ±è¨­å®š (System & Rules) ---
            const SystemView = () => {
                const [editRules, setEditRules] = useState(false);
                const [tempRules, setTempRules] = useState(data.rules);

                const saveRules = () => {
                    setData(p => ({...p, rules: tempRules}));
                    setEditRules(false);
                    showToast("æ³•å‰‡å·²é‡å¯«", "scroll");
                };

                const handleMusicUpload = (e) => {
                    const file = e.target.files[0];
                    if(file){
                        const url = URL.createObjectURL(file);
                        setTempRules({...tempRules, music_url: url});
                        if(audioRef.current) {
                            audioRef.current.src = url;
                            audioRef.current.play();
                            showToast("éŸ³æ¨‚è¼‰å…¥", "music");
                        }
                    }
                }

                return (
                    <div className="space-y-6">
                        <div className="arcane-panel p-8 text-center max-w-md mx-auto">
                            <h3 className="text-xl font-title text-fantasy mb-6">ç³»çµ±æ ¸å¿ƒ</h3>
                            
                            {/* éŸ³æ¨‚æª”æ¡ˆä¸Šå‚³ */}
                            <div className="bg-black/40 p-4 rounded-xl mb-6 text-left border border-gold/30 shadow-lg">
                                <h4 className="text-gold text-sm font-bold mb-3 flex items-center gap-2"><i className="fa-solid fa-music"></i> èƒŒæ™¯éŸ³æ¨‚è¨­å®š</h4>
                                <div className="flex gap-2 mb-2">
                                    <label className="bg-gradient-to-r from-purple-800 to-indigo-800 hover:from-purple-700 hover:to-indigo-700 text-white px-6 py-3 rounded text-sm cursor-pointer flex-1 text-center transition font-bold shadow-md border border-purple-500/50">
                                        <i className="fa-solid fa-file-audio mr-2"></i> é»æ“Šä¸Šå‚³éŸ³æ¨‚æª”æ¡ˆ (MP3)
                                        <input type="file" accept="audio/*" className="hidden" onChange={handleMusicUpload} />
                                    </label>
                                </div>
                                {tempRules.music_url && tempRules.music_url.startsWith('blob:') && <p className="text-xs text-green-400 mb-2"><i className="fa-solid fa-check"></i> å·²è¼‰å…¥æœ¬åœ°æª”æ¡ˆ</p>}
                                <div className="mt-4 flex items-center gap-2">
                                    <label className="text-xs text-gray-400">éŸ³é‡</label>
                                    <input type="range" min="0" max="1" step="0.1" value={tempRules.music_volume || 0.3} onChange={e => {
                                        setTempRules({...tempRules, music_volume: parseFloat(e.target.value)});
                                        if(audioRef.current) audioRef.current.volume = parseFloat(e.target.value);
                                    }} className="flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                                </div>
                            </div>
                            
                            {/* Reset Day Time */}
                             <div className="bg-black/40 p-4 rounded-xl mb-6 text-left border border-gold/30">
                                <h4 className="text-gold text-sm font-bold mb-3">ä¸€æ—¥çµç®—æ™‚é–“</h4>
                                <div className="flex items-center gap-2 text-sm text-gray-300">
                                    <span>æ–°çš„ä¸€å¤©é–‹å§‹æ–¼:</span>
                                    <input type="number" min="0" max="23" className="magic-input w-16 p-1 text-center rounded" value={tempRules.reset_hour || 0} onChange={e => setTempRules({...tempRules, reset_hour: Number(e.target.value)})} />
                                    <span>:00</span>
                                </div>
                                <p className="text-xs text-gray-500 mt-1">ä¾‹å¦‚è¨­å®šç‚º 3ï¼Œå‰‡å‡Œæ™¨ 2:59 ä»ç®—ä½œã€Œæ˜¨å¤©ã€ã€‚</p>
                            </div>

                            <button onClick={() => { 
                                soundEngine.playSFX('click'); 
                                const blob = new Blob([JSON.stringify(data)], {type: "application/json"}); 
                                const url = URL.createObjectURL(blob); 
                                const a = document.createElement('a'); a.href = url; a.download = `save_${new Date().toISOString().split('T')[0]}.json`; a.click(); 
                            }} className="w-full py-3 bg-blue-900/50 hover:bg-blue-800 rounded border border-blue-500/30 text-blue-100 mb-4">ä¸‹è¼‰å­˜æª”</button>
                            <div className="relative mb-8">
                                <button className="w-full py-3 bg-slate-800 hover:bg-slate-700 rounded border border-white/10 text-gray-300">è®€å–å­˜æª”</button>
                                <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => { 
                                    const file = e.target.files[0]; 
                                    if(file) { 
                                        const r = new FileReader(); 
                                        r.onload = (ev) => { 
                                            try { setData(JSON.parse(ev.target.result)); showToast("è®€å–æˆåŠŸ"); } catch { showToast("éŒ¯èª¤", "times"); } 
                                        }; 
                                        r.readAsText(file); 
                                    } 
                                }} />
                            </div>
                            <button onClick={() => { soundEngine.playSFX('error'); confirm("ç¢ºå®šé‡ç½®ï¼Ÿ") && setData(INITIAL_DATA); }} className="text-red-500 hover:text-red-400 text-sm">é‡ç½®æ•¸æ“š</button>
                        </div>

                        {/* ğŸ’° ç¶“æ¿Ÿæ³•å‰‡ç·¨è¼¯å™¨ */}
                        <div className="arcane-panel p-6">
                            <div className="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                                <h3 className="text-xl font-title text-gold"><i className="fa-solid fa-scale-balanced"></i> ç¶“æ¿Ÿæ³•å‰‡ (è²¨å¹£ç²å–è¦å‰‡)</h3>
                                <button onClick={() => editRules ? saveRules() : setEditRules(true)} className="bg-slate-700 px-3 py-1 rounded text-sm">{editRules?'ä¿å­˜':'ç·¨è¼¯'}</button>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="col-span-2 text-gold text-xs font-bold border-b border-white/10 pt-2">åŸºç¤ç”¢é‡</div>
                                <div><label className="text-xs text-gray-400">ç§˜éŠ€ç”¢é‡ (æ¯åˆ†é˜)</label><input type="number" className="magic-input w-full p-2 rounded" disabled={!editRules} value={tempRules.money_per_min} onChange={e=>setTempRules({...tempRules, money_per_min: Number(e.target.value)})}/></div>
                                <div><label className="text-xs text-gray-400">è¨å­ä»»å‹™åŠ æˆ (å€ç‡)</label><input type="number" className="magic-input w-full p-2 rounded" disabled={!editRules} value={tempRules.hate_mult} onChange={e=>setTempRules({...tempRules, hate_mult: Number(e.target.value)})}/></div>
                                
                                <div className="col-span-2 text-gold text-xs font-bold border-b border-white/10 pt-2">é›£åº¦ä¿‚æ•¸</div>
                                <div><label className="text-xs text-green-400">ç°¡å–®ä¿‚æ•¸</label><input type="number" className="magic-input w-full p-2 rounded" disabled={!editRules} value={tempRules.diff_easy} onChange={e=>setTempRules({...tempRules, diff_easy: Number(e.target.value)})}/></div>
                                <div><label className="text-xs text-yellow-400">ä¸­ç­‰ä¿‚æ•¸</label><input type="number" className="magic-input w-full p-2 rounded" disabled={!editRules} value={tempRules.diff_med} onChange={e=>setTempRules({...tempRules, diff_med: Number(e.target.value)})}/></div>
                                <div><label className="text-xs text-orange-400">å›°é›£ä¿‚æ•¸</label><input type="number" className="magic-input w-full p-2 rounded" disabled={!editRules} value={tempRules.diff_hard} onChange={e=>setTempRules({...tempRules, diff_hard: Number(e.target.value)})}/></div>
                                <div><label className="text-xs text-red-400">æ¥µé›£ä¿‚æ•¸</label><input type="number" className="magic-input w-full p-2 rounded" disabled={!editRules} value={tempRules.diff_ext} onChange={e=>setTempRules({...tempRules, diff_ext: Number(e.target.value)})}/></div>
                                
                                <div className="col-span-2 text-gold text-xs font-bold border-b border-white/10 pt-2">ç‰¹æ®Šè²¨å¹£</div>
                                <div><label className="text-xs text-yellow-500">æ˜Ÿè€€é–€æª» (åˆ†é˜)</label><input type="number" className="magic-input w-full p-2 rounded" disabled={!editRules} value={tempRules.star_threshold} onChange={e=>setTempRules({...tempRules, star_threshold: Number(e.target.value)})}/></div>
                                <div><label className="text-xs text-cyan-400">æ¼£æ¼ªçå‹µ (æ‰“å¡)</label><input type="number" className="magic-input w-full p-2 rounded" disabled={!editRules} value={tempRules.checkin_reward} onChange={e=>setTempRules({...tempRules, checkin_reward: Number(e.target.value)})}/></div>
                            </div>
                        </div>
                    </div>
                );
            };

          
            // --- Modal (æ—¥æ›†è©³æƒ…) ---
            const CalendarModal = ({ info, onClose }) => (
                <div className="fixed inset-0 bg-black/90 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-float" onClick={onClose}>
                    <div className="arcane-panel max-w-md w-full p-6 relative border-gold/30 shadow-[0_0_50px_rgba(139,92,246,0.3)]" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-white transition"><i className="fa-solid fa-times fa-lg"></i></button>
                        <h3 className="text-2xl font-title text-fantasy mb-4 border-b border-white/10 pb-2">{info.dateStr}</h3>
                        <div className="space-y-4">
                            <div className="bg-black/40 p-4 rounded text-center">
                                <div className="text-sm text-gray-400 mb-1">ç•¶æ—¥ç¸½æ”¶ç›Š</div>
                                <div className="text-3xl text-gold font-bold">{Math.floor(info.income)} <span className="text-sm">ç§˜éŠ€</span></div>
                                {info.dailyRecord && (
                                    <div className="mt-2 pt-2 border-t border-white/10">
                                        <div className="text-xs text-gray-500 mb-1">ç•¶æ—¥ç›®æ¨™ / å‚™è¨»</div>
                                        <div className="text-sm text-white">{info.dailyRecord.achieved}/{info.dailyRecord.target}</div>
                                        <div className="text-xs text-gray-300 italic">"{info.dailyRecord.note}"</div>
                                    </div>
                                )}
                            </div>
                            <div className="max-h-60 overflow-y-auto custom-scrollbar pr-1">
                                <div className="text-white font-bold mb-2 text-sm border-b border-white/5 pb-1">ğŸ“œ å†’éšªç´€éŒ„</div>
                                {info.logs.length ? info.logs.map((l,i) => (
                                    <div key={i} className="text-xs text-gray-300 bg-white/5 p-2 mb-1 rounded border border-white/5 flex justify-between">
                                        <span>{l.item}</span>
                                        <span className="text-gold">{l.cost}</span>
                                    </div>
                                )) : <div className="text-gray-500 text-xs italic text-center py-2">ç„¡ç´€éŒ„</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );

            // --- é¦–æ¬¡é€²å…¥æ­¡è¿é  ---
            if (!data.setupComplete && started) {
                return (
                    <div className="fixed inset-0 z-50 bg-black flex items-center justify-center p-4">
                        <div className="arcane-panel max-w-lg w-full p-8 text-center animate-fade-in border-2 border-gold">
                            <h1 className="text-4xl font-fantasy text-gold-glow mb-4">éˆé­‚ç¶å®šå„€å¼</h1>
                            <p className="text-gray-300 mb-6 leading-relaxed">æ­¡è¿ä¾†åˆ°æ˜ŸåŸŸä¸»å®°ç³»çµ±ã€‚ä½ æ˜¯è¢«é¸ä¸­çš„æ—…äººã€‚<br/>è«‹å‘ŠçŸ¥ä½ çš„çœŸåï¼Œä»¥ä¾¿éŠ˜åˆ»æ–¼æ™‚å…‰ç¹”éŒ¦ä¹‹ä¸Šã€‚</p>
                            <input className="magic-input w-full p-3 rounded text-center text-xl mb-6 border-gold/50" placeholder="è¼¸å…¥ä½ çš„åå­—..." onKeyDown={(e) => { if(e.key === 'Enter' && e.target.value) { setData(p => ({ ...p, userName: e.target.value, setupComplete: true })); soundEngine.playSFX('success'); } }} />
                            <p className="text-xs text-gray-500">æŒ‰ Enter å®Œæˆå„€å¼</p>
                        </div>
                    </div>
                );
            }

            // --- å•Ÿå‹•é é¢ ---
            if (!started) {
                return (
                    <div className="h-screen flex flex-col items-center justify-center relative z-20">
                        <div className="text-6xl md:text-8xl font-fantasy text-gold-glow mb-8 animate-pulse text-center tracking-widest drop-shadow-[0_0_30px_rgba(255,215,0,0.5)]">
                            æ˜ŸåŸŸä¸»å®°<br/><span className="text-2xl font-sans text-accent tracking-[1em] block mt-4">ASTRAL MASTER</span>
                        </div>
                        <button onClick={startSystem} className="px-12 py-5 bg-transparent border-2 border-gold text-gold font-bold text-xl rounded-full hover:bg-gold hover:text-black transition duration-500 shadow-[0_0_50px_rgba(255,215,0,0.4)] animate-float"><i className="fa-solid fa-play"></i> å•Ÿå‹•é­”æ³•é™£</button>
                    </div>
                );
            }

            // --- ä¸»è¦å…§å®¹ ---
            return (
                <div className="min-h-screen p-4 lg:p-8 flex flex-col lg:flex-row gap-8 max-w-[1600px] mx-auto relative z-10 animate-fade-in">
                    <audio ref={audioRef} loop src={data.rules.music_url || "https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3"} />
                    
                    {toast && <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 arcane-panel px-6 py-3 rounded-full flex items-center gap-3 border border-gold text-gold animate-bounce shadow-[0_0_30px_rgba(255,215,0,0.4)]"><i className={`fa-solid fa-${toast.icon} text-xl`}></i> <span className="font-bold">{toast.msg}</span></div>}
                    {modal && modal.type === 'day_detail' && <CalendarModal info={modal.data} onClose={() => setModal(null)} />}
                    {modal && modal.type === 'daily_welcome' && (
                        <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                            <div className="arcane-panel p-8 text-center border-gold/50 border">
                                <h3 className="text-3xl text-gold mb-4">æ­¡è¿å›ä¾†ï¼Œ{data.userName}</h3>
                                <p className="text-xl text-white italic mb-6">"{modal.quote}"</p>
                                <button onClick={() => setModal(null)} className="btn-primary px-8 py-2 rounded-full">é–‹å§‹å†’éšª</button>
                            </div>
                        </div>
                    )}
                    {modal && modal.type === 'end_day_summary' && (
                        <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                            <div className="arcane-panel p-8 text-center border-gold border shadow-[0_0_50px_rgba(255,215,0,0.5)]">
                                <h3 className="text-4xl font-fantasy text-gold mb-4">æ—…é€”çµç®—</h3>
                                <div className="text-6xl mb-6">ğŸ‰</div>
                                <div className="text-2xl text-white mb-2">ä»Šæ—¥ç²å¾— <span className="text-gold font-bold">{Math.floor(data.profile.today_coins)}</span> ç§˜éŠ€</div>
                                <p className="text-gray-400 mb-4">{data.profile.custom_daily_note || "ä»Šæ—¥ç„¡å‚™è¨»"}</p>
                                <button onClick={() => setModal(null)} className="btn-primary px-8 py-2 rounded-full mt-6">æ˜æ—¥å†æˆ°</button>
                            </div>
                        </div>
                    )}

                    <Sidebar 
    data={data} 
    setData={setData} 
    titleData={titleData} 
    showToast={showToast} 
    setModal={setModal} 
    audioRef={audioRef}
    soundEngine={soundEngine}
/>

                    <div className="flex-1 flex flex-col gap-6 min-w-0">
                        {/* å°èˆª (é †åºä¿®æ­£) */}
                        <div className="arcane-panel p-2 flex overflow-x-auto gap-2 scrollbar-hide border-b-2 border-accent/30">
                            {[
                                { id: "calendar", icon: "calendar-days", label: "æ™‚å…‰ç¹”éŒ¦" },
                                { id: "goals", icon: "compass", label: "å‘½é€”æ˜Ÿåœ–" },
                                { id: "tasks", icon: "scroll", label: "å¾é€”ç¹ªå·" },
                                { id: "adventure_log", icon: "book-journal-whills", label: "å†’éšªæ‰‹æœ­" },
                                { id: "shop", icon: "store", label: "ç¥•æ³•é›†å¸‚" },
                                { id: "history", icon: "clock-rotate-left", label: "äº¤æ˜“ç´€å¹´" },
                                { id: "hall", icon: "dungeon", label: "æ˜Ÿç©¹æ®¿å ‚" },
                                { id: "system", icon: "gears", label: "ç³»çµ±" },
                            ].map(tab => (
                                <button key={tab.id} onClick={() => { setActiveTab(tab.id); soundEngine.playSFX('click'); }} className={`px-5 py-3 rounded-lg font-bold whitespace-nowrap transition flex items-center gap-2 ${activeTab === tab.id ? 'bg-gradient-to-r from-indigo-900 to-purple-900 text-white border border-accent shadow-[0_0_20px_rgba(139,92,246,0.4)]' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}>
                                    <i className={`fa-solid fa-${tab.icon}`}></i> {tab.label}
                                </button>
                            ))}
                        </div>

                        <div className="min-h-[500px]">
                            {activeTab === "calendar" && <CalendarView />}
                            {activeTab === "goals" && <GoalView />}
                            {activeTab === "tasks" && <TaskView />}
                            {activeTab === "adventure_log" && <AdventureLogView />}
                            {activeTab === "shop" && <ShopView />}
                            {activeTab === "history" && <HistoryView />}
                            {activeTab === "hall" && <HallView />}
                            {activeTab === "system" && <SystemView />}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
